create table events  (
	user_id VARCHAR(1),
	created_at DATE,
	url  VARCHAR(10)
);

insert into events values
    (4, '2020-05-10', 'bing.com'),
    (1, '2020-05-12', 'webs.com'),
    (1, '2020-05-01', 'sohu.com'),
    (1, '2020-05-03', 'bing.com'),
    (1, '2020-05-05', 'bing.com'),
    (1, '2020-05-06', 'bing.com'),
    (1, '2020-05-07', 'bing.com'),
    (1, '2020-05-08', 'bing.com'),
    (2, '2020-05-06', 'sohu.com'),
    (4, '2020-05-13', 'sohu.com'),
    (4, '2020-05-05', 'webs.com'),
    (2, '2020-05-06', 'webs.com'),
    (1, '2020-05-07', 'unesco.org'),
    (1, '2020-05-02', 'webs.com'),
    (3, '2020-05-12', 'webs.com'),
    (4, '2020-05-08', 'sohu.com'),
    (2, '2020-05-12', 'weebly.com'),
    (4, '2020-05-08', 'unesco.org'),
    (4, '2020-05-01', 'unesco.org'),
    (2, '2020-05-06', 'webs.com'),
    (4, '2020-05-10', 'webs.com'),
    (3, '2020-05-11', 'bing.com'),
    (2, '2020-05-07', 'sohu.com'),
    (4, '2020-05-06', 'weebly.com'),
    (1, '2020-05-13', 'bing.com'),
    (3, '2020-05-11', 'unesco.org'),
    (2, '2020-05-07', 'bing.com'),
    (1, '2020-05-01', 'bing.com'),
    (3, '2020-05-05', 'weebly.com'),
    (4, '2020-05-08', 'sohu.com'),
    (3, '2020-05-08', 'weebly.com'),
    (2, '2020-05-05', 'sohu.com'),
    (3, '2020-05-11', 'unesco.org'),
    (4, '2020-05-03', 'weebly.com'),
    (2, '2020-05-07', 'unesco.org'),
    (3, '2020-05-08', 'unesco.org'),
    (2, '2020-05-10', 'webs.com'),
    (3, '2020-05-07', 'weebly.com'),
    (1, '2020-05-06', 'unesco.org'),
    (1, '2020-05-03', 'webs.com'),
    (4, '2020-05-11', 'sohu.com'),
    (4, '2020-05-03', 'webs.com'),
    (1, '2020-05-08', 'webs.com'),
    (1, '2020-05-03', 'unesco.org'),
    (1, '2020-05-02', 'bing.com'),
    (3, '2020-05-06', 'weebly.com'),
    (2, '2020-05-11', 'unesco.org'),
    (3, '2020-05-06', 'webs.com'),
    (4, '2020-05-10', 'bing.com'),
    (1, '2020-05-07', 'weebly.com'),
    (4, '2020-05-05', 'weebly.com'),
    (2, '2020-05-11', 'weebly.com'),
    (4, '2020-05-13', 'sohu.com'),
    (2, '2020-05-14', 'webs.com'),
    (2, '2020-05-05', 'bing.com'),
    (3, '2020-05-04', 'bing.com'),
    (1, '2020-05-04', 'bing.com'),
    (2, '2020-05-08', 'sohu.com'),
    (2, '2020-05-10', 'sohu.com'),
    (3, '2020-05-14', 'sohu.com'),
    (3, '2020-05-07', 'bing.com'),
    (3, '2020-05-11', 'webs.com'),
    (2, '2020-05-06', 'bing.com'),
    (4, '2020-05-01', 'weebly.com'),
    (4, '2020-05-05', 'unesco.org'),
    (1, '2020-05-06', 'webs.com'),
    (3, '2020-05-12', 'webs.com'),
    (4, '2020-05-01', 'bing.com'),
    (1, '2020-05-13', 'unesco.org'),
    (2, '2020-05-13', 'sohu.com'),
    (1, '2020-05-08', 'sohu.com'),
    (1, '2020-05-14', 'weebly.com'),
    (1, '2020-05-03', 'sohu.com'),
    (4, '2020-05-03', 'webs.com'),
    (4, '2020-05-12', 'sohu.com'),
    (4, '2020-05-07', 'sohu.com'),
    (2, '2020-05-14', 'bing.com'),
    (3, '2020-05-14', 'webs.com'),
    (4, '2020-05-06', 'bing.com'),
    (3, '2020-05-03', 'webs.com'),
    (4, '2020-05-06', 'bing.com'),
    (2, '2020-05-12', 'webs.com'),
    (3, '2020-05-01', 'bing.com'),
    (2, '2020-05-01', 'webs.com'),
    (3, '2020-05-04', 'webs.com'),
    (2, '2020-05-05', 'sohu.com'),
    (3, '2020-05-12', 'webs.com'),
    (2, '2020-05-02', 'webs.com'),
    (2, '2020-05-07', 'unesco.org'),
    (1, '2020-05-13', 'unesco.org'),
    (4, '2020-05-08', 'webs.com'),
    (2, '2020-05-04', 'bing.com'),
    (2, '2020-05-06', 'unesco.org'),
    (1, '2020-05-09', 'bing.com'),
    (1, '2020-05-06', 'unesco.org'),
    (2, '2020-05-14', 'weebly.com'),
    (1, '2020-05-12', 'weebly.com'),
    (3, '2020-05-10', 'unesco.org'),
    (1, '2020-05-03', 'webs.com'),
    (2, '2020-05-05', 'bing.com'),
    (4, '2020-05-11', 'unesco.org'),
    (2, '2020-05-01', 'weebly.com'),
    (1, '2020-05-03', 'unesco.org'),
    (1, '2020-05-06', 'sohu.com'),
    (3, '2020-05-04', 'bing.com'),
    (2, '2020-05-03', 'webs.com'),
    (2, '2020-05-07', 'webs.com'),
    (2, '2020-05-08', 'webs.com'),
    (2, '2020-05-09', 'webs.com'),
    (2, '2020-05-11', 'webs.com'),
    (2, '2020-05-13', 'webs.com');


--Given a table with event logs, find the percentage of users that had at least one seven-day streak     of visiting the same s.url .

-- find 7 day streak
/*
with streak as (
    select x.user_id as users, count(distinct x.streak)
from (
    select *, case when 
            s.url  = lag(s.url ) over(partition by s.url  order by s.created_at) and
            s.url  = lag(s.url ,2) over(partition by s.url  order by s.created_at) and
            s.url  = lag(s.url ,3) over(partition by s.url  order by s.created_at) and
            s.url  = lag(s.url ,4) over(partition by s.url  order by s.created_at) and
            s.url  = lag(s.url ,5) over(partition by s.url  order by s.created_at) and
            s.url  = lag(s.url ,6) over(partition by s.url  order by s.created_at) and
            s.url  = lag(s.url ,7) over(partition by s.url  order by s.created_at)
            then s.url 
            else null
            end as streak
from (select x.user_id, x.created_at, x.url  from (
select *, row_number() over(partition by user_id, created_at, url order by url) as times_visited
from events
where user_id in (1,2)
) x
where times_visited < 2) s
) x )

select count(s.users)/count(distinct e.user_id)+0.0 as precent_of_users
from events e, streak s
*/

with base as (
    select user_id, url, created_at
    , lag(created_at, 1) over (partition by user_id, url order by created_at) as last_date
    , row_number() over (partition by user_id, url order by created_at) as r
    from events 
),

step as (
select *
    , coalesce(julianday(created_at) - julianday(last_date),0) as date_diff
    , max(r) over (partition by user_id, url) as max_visit
    from base
)
, step2 as (
    select user_id, url, max_visit, sum(date_diff) as sum_date_diff
    from step
    group by 1,2,3
)

select round(count(distinct case when max_visit >= 7 and sum_date_diff = max_visit -1 then user_id end)/ count(distinct user_id)*1.0,2) as precent_of_users
from step2

/*
1|bing.com|2020-05-01|          |1|0.0|10
1|bing.com|2020-05-02|2020-05-01|2|1.0|10
1|bing.com|2020-05-03|2020-05-02|3|1.0|10
1|bing.com|2020-05-04|2020-05-03|4|1.0|10
1|bing.com|2020-05-05|2020-05-04|5|1.0|10
1|bing.com|2020-05-06|2020-05-05|6|1.0|10
1|bing.com|2020-05-07|2020-05-06|7|1.0|10
1|bing.com|2020-05-08|2020-05-07|8|1.0|10
1|bing.com|2020-05-09|2020-05-08|9|1.0|10
1|bing.com|2020-05-13|2020-05-09|10|4.0|10

1|bing.com|10|12.0

1|sohu.com|2020-05-01|          |1|0.0|4
1|sohu.com|2020-05-03|2020-05-01|2|2.0|4
1|sohu.com|2020-05-06|2020-05-03|3|3.0|4
1|sohu.com|2020-05-08|2020-05-06|4|2.0|4

1|sohu.com|4|7.0
    
1|unesco.org|2020-05-03|          |1|0.0|7
1|unesco.org|2020-05-03|2020-05-03|2|0.0|7
1|unesco.org|2020-05-06|2020-05-03|3|3.0|7
1|unesco.org|2020-05-06|2020-05-06|4|0.0|7
1|unesco.org|2020-05-07|2020-05-06|5|1.0|7
1|unesco.org|2020-05-13|2020-05-07|6|6.0|7
1|unesco.org|2020-05-13|2020-05-13|7|0.0|7

1|unesco.org|7|10.0
    
1|webs.com|2020-05-02|          |1|0.0|6
1|webs.com|2020-05-03|2020-05-02|2|1.0|6
1|webs.com|2020-05-03|2020-05-03|3|0.0|6
1|webs.com|2020-05-06|2020-05-03|4|3.0|6
1|webs.com|2020-05-08|2020-05-06|5|2.0|6
1|webs.com|2020-05-12|2020-05-08|6|4.0|6

1|webs.com|6|10.0
    
1|weebly.com|2020-05-07|          |1|0.0|3
1|weebly.com|2020-05-12|2020-05-07|2|5.0|3
1|weebly.com|2020-05-14|2020-05-12|3|2.0|3

1|weebly.com|3|7.0
    
*/